##
##  MQTT+ -- MQTT Communication Patterns
##  Copyright (c) 2018-2026 Dr. Ralf S. Engelschall <rse@engelschall.com>
##
##  Permission is hereby granted, free of charge, to any person obtaining
##  a copy of this software and associated documentation files (the
##  "Software"), to deal in the Software without restriction, including
##  without limitation the rights to use, copy, modify, merge, publish,
##  distribute, sublicense, and/or sell copies of the Software, and to
##  permit persons to whom the Software is furnished to do so, subject to
##  the following conditions:
##
##  The above copyright notice and this permission notice shall be included
##  in all copies or substantial portions of the Software.
##
##  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
##  EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
##  MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.
##  IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY
##  CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,
##  TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE
##  SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
##

#   static code analysis (linting)
lint
    tsc --project etc/tsc.json --noEmit && \
    eslint --config etc/eslint.mts src/*.ts sample/*.ts

#   code compilation/transpiling (building)
build : lint
    VITE_BUILD_FORMATS=es,cjs vite --config etc/vite.mts build --mode production
    VITE_BUILD_FORMATS=umd    vite --config etc/vite.mts build --mode production

build-doc
    node etc/d2.mts doc/theme.d2 doc/mqtt-plus-1-event-emission.d2    doc/mqtt-plus-1-event-emission.svg
    node etc/d2.mts doc/theme.d2 doc/mqtt-plus-2-service-call.d2      doc/mqtt-plus-2-service-call.svg
    node etc/d2.mts doc/theme.d2 doc/mqtt-plus-3-resource-transfer.d2 doc/mqtt-plus-3-resource-transfer.svg

#   run test suite
test
    tsc --project tst/tsc.json --noEmit && \
    eslint --config etc/eslint.mts tst/mqtt-plus.spec.ts && \
    NODE_OPTIONS="--import=tsx --trace-warnings" mocha tst/mqtt-plus.spec.ts

#   execute simple sample for testing
sample
    npx tsx sample/sample.ts

#   cleanup (built artifacts)
clean
    shx rm -rf dst

#   cleanup (bootstrap artifacts)
distclean : clean
    shx rm -f package-lock.json
    shx rm -rf node_modules

